<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.8.0" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.8.0" type="image/png" sizes="32x32"><meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary"><title>Hexo</title><link ref="canonical" href="http://example.com/page/3/index.html"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.8.0"><link rel="stylesheet" href="css/custom.css"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Hello Stun</div><div class="header-banner-info__subtitle">An elegant theme for Hexo</div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content content-home" id="content"><section class="postlist"><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2025/09/10/linux%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/docker%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6%E8%87%B3%E5%AE%B9%E5%99%A8/">[ Untitled ]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2025-09-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2024-07-08</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>docker上传文件至容器</p>

        <h4 id="拿到容器ID"   >
          <a href="#拿到容器ID" class="heading-link"><i class="fas fa-link"></i></a><a href="#拿到容器ID" class="headerlink" title="拿到容器ID"></a>拿到容器ID</h4>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></div></figure>


        <h4 id="将本地文件上传到容器的指定目录中"   >
          <a href="#将本地文件上传到容器的指定目录中" class="heading-link"><i class="fas fa-link"></i></a><a href="#将本地文件上传到容器的指定目录中" class="headerlink" title="将本地文件上传到容器的指定目录中"></a>将本地文件上传到容器的指定目录中</h4>
      <figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> 本地文件路径 ID全称:容器路径</span><br></pre></td></tr></table></div></figure>

<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">cp</span> /home/stydent/EdgeGPT /usr/local/lib/python3.11/site-packages</span><br></pre></td></tr></table></div></figure>

<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> docker <span class="built_in">cp</span> fbf56805d23a:/usr/local/lib/python3.11/site-packages ./site-packages</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2025/09/10/linux%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/Docker%20Desktop%20%E4%BF%AE%E6%94%B9%E5%AE%89%E8%A3%85%E4%BD%8D%E7%BD%AE-CSDN%E5%8D%9A%E5%AE%A2/">[ Untitled ]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2025-09-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2024-06-26</span></span></div></header><div class="post-body"><div class="post-excerpt"><p><span class="exturl"><a class="exturl__link"   target="_blank" rel="noopener" href="https://blog.csdn.net/cn_ljr/article/details/132047516" >Win11 安装 Docker Desktop 和 WSL2 并进行安装位置迁移_windows 11 wsl 修改安装位置-CSDN博客</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>迁移docker</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2025/09/10/%E7%AC%94%E8%AE%B0%E6%9D%82%E9%A1%B9/os/%E8%B0%83%E8%AF%95bootloader/">[ Untitled ]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2025-09-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2024-10-06</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>gdb调试</p>
<p>目的：复现jyy的调试过程</p>
<p>直接执行<code>make debug</code>会报错，显示<code>no file</code>问题就是boot里的文件是bootblock.o而不是boot.o，所以在其Makefile里添加</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> bootblock.o boot.o</span><br></pre></td></tr></table></div></figure>

<p>复制一份，如何就再次执行<code>make debug </code>就会出现新的bug</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb.error: <span class="string">&quot;/home/cgz/work/os-workbench/abstract-machine/am/src/x86/qemu/boot/boot.o&quot;</span>: not <span class="keyword">in</span> executable format: file format not recognized</span><br></pre></td></tr></table></div></figure>

<p>显示格式不能识别，问gpt回答为该种格式不能直接调试，需要启动qemu，连接调试，事实也是这样，</p>
<p>问题不是这个。所以就是Makefile里缺少-ggdb</p>
<p>需要-ggdb提供调试信息，gdb才能调试可执行文件</p>
<p>在</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abstract-machine/am/src/x86/qemu/boot/Makefile</span><br></pre></td></tr></table></div></figure>

<p>添加-ggdb可以同时解决打印不出来的问题，不实现stdio里的printf函数也能打印</p>
<p>设置<code>$AM_HOME</code>为pa的框架，改写Makefile不起作用</p>
<p>但是改写为直接clone的</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/cgz/work/os-workbench/abstract-machine/am/src/x86/qemu/boot/Makefile</span><br></pre></td></tr></table></div></figure>

<p>就能正常使用printf，但是用make debug还是没有标记</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb.error: &quot;/home/cgz/work/os-workbench/abstract-machine/am/src/x86/qemu/boot/boot.o&quot;: not in executable format: file format not recognized</span><br></pre></td></tr></table></div></figure>

<p>造成这个的原因是在文件上没有gdb可以识别的标记</p>
<p>解决方法应该是加上-ggdb应该就可以</p>
<p>但是还是报错没有标记，把bulid生成的.o文件全部删除，再执行也一样。</p>
<p>尝试把py程序代码手动输入，看看能否解决</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">debug:</span><br><span class="line">	qemu-system-i386 -s -S -machine accel=tcg -smp <span class="string">&quot;1,sockets=1&quot;</span> \</span><br><span class="line">		-drive format=raw,file=build/hello-x86-qemu &amp;</span><br><span class="line">	gdb -x debug.py</span><br></pre></td></tr></table></div></figure>

<figure class="highlight python"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Register the quit hook</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_quit</span>():</span><br><span class="line">    gdb.execute(<span class="string">&#x27;kill&#x27;</span>)</span><br><span class="line"></span><br><span class="line">gdb.events.exited.connect(on_quit)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Connect to the remote target</span></span><br><span class="line">gdb.execute(<span class="string">&#x27;target remote localhost:1234&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load the debug symbols</span></span><br><span class="line">am_home = os.environ[<span class="string">&#x27;AM_HOME&#x27;</span>]</span><br><span class="line">path = <span class="string">f&#x27;<span class="subst">&#123;am_home&#125;</span>/am/src/x86/qemu/boot/boot.o&#x27;</span></span><br><span class="line">gdb.execute(<span class="string">f&#x27;file <span class="subst">&#123;path&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># This is the 0x7c00</span></span><br><span class="line">gdb.Breakpoint(<span class="string">&#x27;_start&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># This is where 32-bit code starts</span></span><br><span class="line">gdb.Breakpoint(<span class="string">&#x27;start32&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Continue execution</span></span><br><span class="line">gdb.execute(<span class="string">&#x27;continue&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>提取出命令</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-i386 -s -S -machine accel=tcg -smp <span class="string">&quot;1,sockets=1&quot;</span> -drive format=raw,file=build/hello-x86-qemu &amp;</span><br><span class="line">//打开虚拟机文件夹</span><br><span class="line">gdb am/src/x86/qemu/boot/boot.o</span><br><span class="line"></span><br><span class="line">target remote localhost:1234</span><br><span class="line"></span><br><span class="line">//然后打断点执行</span><br><span class="line">(gdb)b _start</span><br><span class="line">(gdb)b start 32</span><br><span class="line">(gdb)c</span><br><span class="line"></span><br></pre></td></tr></table></div></figure>

<p>同样的报错</p>
<p><strong>已解决</strong></p>
<p>把Makefile的两行交换位置即可</p>
<figure class="highlight makefile"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SRCS := start.S main.c</span><br><span class="line"><span class="section">bootblock.o: <span class="variable">$(SRCS)</span> Makefile</span></span><br><span class="line">        @echo + CC <span class="variable">$(SRCS)</span></span><br><span class="line">        @<span class="variable">$(CROSS_COMPILE)</span>gcc -ggdb -static -m32 -fno-pic -Os -nostdlib  -Ttext 0x7c00 -I<span class="variable">$(AM_HOME)</span>/am/src -o bootblock.o <span class="variable">$(SRCS)</span></span><br><span class="line">        cp bootblock.o boot.o</span><br><span class="line">        @python3 genboot.py bootblock.o<span class="comment">#该pyhton程序的作用是将bootblock.o转换成其他格式供底层程序使用，破坏了其可调试性</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">        rm -rf *.o</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2025/09/10/%E7%AC%94%E8%AE%B0%E6%9D%82%E9%A1%B9/os/%E8%B0%83%E8%AF%95/">[ Untitled ]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2025-09-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2024-10-08</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h3 id="理解状态机执行：不是-“调试”，也是-“调试”"   >
          <a href="#理解状态机执行：不是-“调试”，也是-“调试”" class="heading-link"><i class="fas fa-link"></i></a><a href="#理解状态机执行：不是-“调试”，也是-“调试”" class="headerlink" title="理解状态机执行：不是 “调试”，也是 “调试”"></a>理解状态机执行：不是 “调试”，也是 “调试”</h3>
      <ul>
<li><code>ssh</code>：使用 <code>-v</code> 选项检查日志</li>
<li><code>gcc</code>：使用 <code>-v</code> 选项打印各种过程</li>
<li><code>make</code>：使用 <code>-nB</code> 选项查看完整命令历史</li>
</ul>

        <h3 id="调试：不仅是-“调试器”"   >
          <a href="#调试：不仅是-“调试器”" class="heading-link"><i class="fas fa-link"></i></a><a href="#调试：不仅是-“调试器”" class="headerlink" title="调试：不仅是 “调试器”"></a>调试：不仅是 “调试器”</h3>
      <ul>
<li>Profiler: <code>perf</code> - “采样” 状态机</li>
<li>Trace: <code>strace</code> - 追踪系统调用</li>
</ul>
<p>将日志文件重定向到vim进行各种操作</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strace -f g++ a.cc |&amp; vim -</span><br></pre></td></tr></table></div></figure>

<p>执行 <code>grep</code> 命令进行过滤，可以通过 <code>:!</code> 来运行外部命令并将结果显示在 <code>vim</code> 中。</p>
<p>步骤如下：</p>
<ol>
<li><p>在 <code>vim</code> 中输入：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:!grep <span class="string">&quot;关键词&quot;</span> 文件名</span><br></pre></td></tr></table></div></figure>

<p>或者，你可以直接对 <code>vim</code> 缓冲区的内容使用管道进行过滤：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:%!grep <span class="string">&quot;关键词&quot;</span></span><br></pre></td></tr></table></div></figure>

<ul>
<li><code>:!grep &quot;关键词&quot;</code>：会在当前终端执行 <code>grep</code>，但不影响你在 <code>vim</code> 中的内容。</li>
<li><code>:%!grep &quot;关键词&quot;</code>：会将当前文件内容通过管道传递给 <code>grep</code>，然后将过滤结果替换当前文件的内容。</li>
</ul>
</li>
<li><p>例如：</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:%!grep <span class="string">&quot;error&quot;</span></span><br></pre></td></tr></table></div></figure>

<p>这会将所有包含 <code>error</code> 的行保留，并替换掉当前缓冲区的内容。</p>
</li>
</ol>
<p>如果包含.h这种，使用转义字符</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:%!grep <span class="string">&quot;\.h&quot;</span></span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2025/09/10/%E7%AC%94%E8%AE%B0%E6%9D%82%E9%A1%B9/os/%E6%A8%A1%E6%8B%9F%E5%AE%9E%E7%8E%B0Windows%E7%B3%BB%E7%BB%9F%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86%E5%99%A8/">[ Untitled ]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2025-09-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2024-12-19</span></span></div></header><div class="post-body"><div class="post-excerpt">
        <h1 id="题目1：模拟实现Windows系统资源管理器"   >
          <a href="#题目1：模拟实现Windows系统资源管理器" class="heading-link"><i class="fas fa-link"></i></a><a href="#题目1：模拟实现Windows系统资源管理器" class="headerlink" title="题目1：模拟实现Windows系统资源管理器"></a>题目1：模拟实现Windows系统资源管理器</h1>
      <p>报告内容至少包括关键的数据结构、算法流程图、结果展示和人员分工。</p>
<p>课程设计目的：熟悉操作系统资源管理原理，掌握编程接口，能够使用高级语言调用编程接口，设计并实现Windows操作系统任务管理器的全部功能。</p>
 <img src="C:/Users/86147/Desktop/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E8%AE%BE/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20241219210333.png" alt="微信图片_20241219210333" style="zoom: 67%;" />

<p><img src="C:/Users/86147/Desktop/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E8%AE%BE/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20241219210338.png" alt="微信图片_20241219210338"></p>
<p><img src="C:/Users/86147/Desktop/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E8%AF%BE%E8%AE%BE/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20241219210357.png" alt="微信图片_20241219210357"></p>
<p>创新点，持久化，拖拽，前进后退，支持用路径和文件名查找文件</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2025/09/10/%E7%AC%94%E8%AE%B0%E6%9D%82%E9%A1%B9/os/%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98/">[ Untitled ]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2025-09-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2024-10-14</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>该例子是一个生产者一个消费者，缓冲区是1，如果缓冲区很大这个问题就会被忽视了，如果生产者和消费者数量增加，那么死锁概率也会增加</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//错误的</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">wait</span><span class="params">(<span class="keyword">struct</span> condvar *cv, <span class="type">mutex_t</span> *mutex)</span>&#123;</span><br><span class="line">    mutex_lock(&amp;cv -&gt; lock);</span><br><span class="line">    cv -&gt; nwait++;</span><br><span class="line">    mutex_unlock(&amp;cv -&gt; lock);</span><br><span class="line"><span class="comment">//理想状态是球在生产者和消费者之间传递    </span></span><br><span class="line">    mutex_unlock(mutex);</span><br><span class="line">    <span class="comment">//但是如果在这里broadcast抢占，先唤醒了，然后nwait=0了，</span></span><br><span class="line">    <span class="comment">//就相当于唤醒了另一个同样是生产者或者是消费者线程甚至是自己把球抢走了，再检查条件再进入wait,但是没有线程再放球了就会死锁</span></span><br><span class="line">    P(&amp;cv -&gt; sleep);<span class="comment">//这个睡眠和解锁顺序不能更改</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    mutex_lock(mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

<p>问题是，为什么前一个线程执行完的broadcast后，consumer（12896）为什么没被唤醒，而后面的producer(12897)被唤醒了，而且例子中只有一个生产者和一个消费者，缓冲区大小为1</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">------Consumer: begin, execution count: <span class="number">12896</span>------</span><br><span class="line">Consumer: Waiting</span><br><span class="line">------waiting------</span><br><span class="line">in wait nwait: <span class="number">1</span></span><br><span class="line">waiting before sleep</span><br><span class="line"></span><br><span class="line">------Producer: begin, execution count: <span class="number">12896</span>------</span><br><span class="line">(</span><br><span class="line">depth = <span class="number">1</span></span><br><span class="line">Producer: Broadcast</span><br><span class="line">------broadcast_start------</span><br><span class="line">start broadcast</span><br><span class="line"><span class="type">int</span> broadcast nwait: <span class="number">1</span></span><br><span class="line">------broadcast_end------</span><br><span class="line">------Producer: end, execution count: <span class="number">12896</span>------</span><br><span class="line">    </span><br><span class="line">------Producer: begin, execution count: <span class="number">12897</span>------</span><br><span class="line">Producer: Waiting</span><br><span class="line">------waiting------</span><br><span class="line">in wait nwait: <span class="number">1</span></span><br><span class="line">waiting before sleep</span><br><span class="line">------waiting out------</span><br><span class="line">Producer: Waiting</span><br><span class="line">------waiting------</span><br><span class="line">in wait nwait: <span class="number">2</span></span><br><span class="line">waiting before sleep</span><br></pre></td></tr></table></div></figure>

</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2025/09/10/%E7%AC%94%E8%AE%B0%E6%9D%82%E9%A1%B9/os/%E5%AE%9E%E7%8E%B0%E5%BA%93%E5%87%BD%E6%95%B0printf/">[ Untitled ]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2025-09-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2024-09-29</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>实现库函数printf</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>    <span class="title function_">printf</span>    <span class="params">(<span class="type">const</span> <span class="type">char</span> *format, ...)</span>;</span><br></pre></td></tr></table></div></figure>

<p>这个程序除了调用的库函数不同 (例如没有 stdio.h；多了 am.h) 之外，它就是一个完全符合 C 标准的普通程序，但因为没有操作系统和标准库的支持，我们需要编写所有的库函数。例如，printf 也来自我们的代码，它调用了 AbstractMachine 提供的 putch API:</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2025/09/10/%E7%AC%94%E8%AE%B0%E6%9D%82%E9%A1%B9/os/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">[ Untitled ]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2025-09-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2024-10-03</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>多线程</p>
<p>独立的栈，共享的内存空间</p>
<p>阅读thread.h源码</p>
<p>在thread-qa中</p>
<p>将thread.h移入文件夹，执行make报错找不到库</p>
<p>解决方法：设置TLIB_PATH路径为thread.h所在的文件夹</p>
<figure class="highlight makefile"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CFLAGS := -O1 -g -I<span class="variable">$(TLIB_PATH)</span></span><br></pre></td></tr></table></div></figure>

<p>解释</p>
<ol>
<li><code>-I$(TLIB_PATH)</code>：<ul>
<li>这个选项指定了一个包含路径，该路径由 <code>$(TLIB_PATH)</code> 变量定义。</li>
<li><code>$(TLIB_PATH)</code> 可能在 [Makefile](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 的其他地方定义，或者在运行 <code>make</code> 命令时通过环境变量传递。</li>
<li>编译器会在 <code>$(TLIB_PATH)</code> 指定的目录中查找头文件。</li>
</ul>
</li>
<li><code>-I.</code>：<ul>
<li>这个选项指定当前目录（<code>.</code>）作为包含路径。</li>
<li>编译器会在当前目录中查找头文件。</li>
</ul>
</li>
</ol>
<p>多个进程读取写入</p>
<p>支付宝，第一个减去100，第二个在该进程没有减去的时候进行条件判断，也减去100，由于是unsigned long 结果变成很大的数</p>

        <h3 id="copilot解释"   >
          <a href="#copilot解释" class="heading-link"><i class="fas fa-link"></i></a><a href="#copilot解释" class="headerlink" title="copilot解释"></a>copilot解释</h3>
      
        <h4 id="竞态条件的发生"   >
          <a href="#竞态条件的发生" class="heading-link"><i class="fas fa-link"></i></a><a href="#竞态条件的发生" class="headerlink" title="竞态条件的发生"></a>竞态条件的发生</h4>
      <ol>
<li><strong>共享变量</strong>：[<code>balance</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 是一个全局变量，多个线程可以同时访问和修改它。</li>
<li><strong>线程创建</strong>：[<code>main</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 函数中创建了两个线程，分别执行 [<code>T_alipay</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 函数。</li>
<li><strong>函数调用</strong>：每个线程调用 <code>Alipay_withdraw(100)</code>，尝试从 [<code>balance</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 中扣除 100。</li>
</ol>

        <h4 id="竞态条件的具体过程"   >
          <a href="#竞态条件的具体过程" class="heading-link"><i class="fas fa-link"></i></a><a href="#竞态条件的具体过程" class="headerlink" title="竞态条件的具体过程"></a>竞态条件的具体过程</h4>
      <ol>
<li><p><strong>线程1和线程2同时检查 [<code>balance</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html)</strong>：</p>
<ul>
<li>线程1检查 [<code>balance</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 是否大于等于 100，结果为真。</li>
<li>线程2也检查 [<code>balance</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 是否大于等于 100，结果也为真。</li>
</ul>
</li>
<li><p><strong>线程1和线程2同时进入 [<code>if</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 块</strong>：</p>
<ul>
<li>线程1进入 [<code>if</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 块并调用 <code>usleep(1)</code>，暂时让出CPU。</li>
<li>线程2也进入 [<code>if</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 块并调用 <code>usleep(1)</code>，暂时让出CPU。</li>
</ul>
</li>
<li><p><strong>线程1和线程2同时修改 [<code>balance</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html)</strong>：</p>
<ul>
<li>线程1从 [<code>balance</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 中减去 100，[<code>balance</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 变为 0。</li>
<li>线程2也从 [<code>balance</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 中减去 100，[<code>balance</code>](vscode-file:&#x2F;&#x2F;vscode-app&#x2F;c:&#x2F;Users&#x2F;86147&#x2F;AppData&#x2F;Local&#x2F;Programs&#x2F;Microsoft VS Code&#x2F;resources&#x2F;app&#x2F;out&#x2F;vs&#x2F;code&#x2F;electron-sandbox&#x2F;workbench&#x2F;workbench.html) 无符号整数会溢出</li>
</ul>
</li>
</ol>
<p>如果是两个进程都循环加1加到10000，结果不会是20000</p>
<p>原代码反汇编</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">13ea:       48 8b 05 4f 2c 00 00    mov    0x2c4f(%rip),%rax       </span><br><span class="line"># 4040 &lt;sum&gt;</span><br><span class="line">13f1:       48 83 c0 01             add    $0x1,%rax</span><br><span class="line">13f5:       48 89 05 44 2c 00 00    mov    %rax,0x2c44(%rip) </span><br></pre></td></tr></table></div></figure>

<p>修改成一条汇编指令</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">13ea:       48 ff 05 4f 2c 00 00    incq   0x2c4f(%rip)  </span><br></pre></td></tr></table></div></figure>

<p>改成一条指令，如果在一个处理器上还能正确，但是在多处理器上还会错误。</p>
<p>看着是一条指令，实际上不是原子指令。</p>
<p><code>printf</code>是线程安全的</p>
<p>因为汇编指令取值，在中间寄存器加1后可能会中断，再放入变量对应地址中，结果可能就只是加一个1，而不是两个1</p>
<p>最小可以小于10000，可以改成汇编指令</p>
<p>为什么是2？</p>
<p>每个进程有一个n次循环，n个进程</p>
<p>在关键进程中，最后一步store，之前，已经循环了n-1次了，这两次的最小值为1（进程A第一个循环store()时，关键进程第n-1个循环正好结束，进程A，store后sum&#x3D;1）关键进程执行前两步，然后关键进程等待其他进程结束后执行store(2,sum)</p>
<p>编译器优化，可能会隐藏并发的bug(都假设状态迁移是原子性，顺序执行)</p>
<p>O1优化sum&#x3D;100000000</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">load(sum + N)</span><br><span class="line">;循环N次</span><br><span class="line">store(num)</span><br></pre></td></tr></table></div></figure>



<p>O2优化sum&#x3D;200000000</p>
<figure class="highlight plaintext"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0000000000001260 &lt;T_sum&gt;:</span><br><span class="line">    1264:       48 81 05 d1 2d 00 00    addq   $0x5f5e100,0x2dd1(%rip)       </span><br><span class="line"> ;改成了一条指令，两个进程碰在一起的概率很低</span><br></pre></td></tr></table></div></figure>



<p>处理器也是编译器，所以单线程的处理器可能会优化，调换程序执行的顺序（在结果不变的情况下）</p>
<p>也是状态机，流水线，读写不冲突就能同时执行</p>
<p>所以……相对论？</p>
<p>共享内存只是一个简化的假象</p>
<p>mem-modle</p>
<p>一个是写Y读X，一个是写X读Y，得按特定顺序才能输出1，1，所以很少</p>
<p>arm与x86的内存模型不同，对于多线程的程序模拟难度大</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2025/09/10/%E7%AC%94%E8%AE%B0%E6%9D%82%E9%A1%B9/os/%E4%BA%92%E6%96%A5/">[ Untitled ]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2025-09-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2024-10-08</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>实现原子指令用到了什么，一小段的不可被打断的指令</p>
<p>自旋锁，把<code>1</code>交换出去，其他的线程只能交换出<code>0</code>，并不断循环交换，临界区结束了之后把<code>1</code>还回去</p>
<p>另一个线程就把锁换过来</p>
<p>如果<code>lock</code> <code>unlock</code>函数加上参数，就相当于可以设多个锁，试图得到同一把锁的线程就实现了互斥</p>
<p><code>lock(&amp;status)</code></p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">holding</span><span class="params">(<span class="type">spinlock_t</span> *lk)</span> &#123;<span class="comment">//当前是有锁状态，且锁的拥有者是当前cpu</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        lk-&gt;status == LOCKED &amp;&amp;</span><br><span class="line">        lk-&gt;cpu == &amp;cpus[cpu_current()]</span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>





<p>要正确使用锁很难，要经常使用断言，检查中断是否符合预测<code>assert</code>，可以读读<strong>xv6源码</strong></p>
<p>在用户态</p>
<p>用户程序<code>sum++</code>拥有锁，被操作系统中断了，切换到了其他程序，</p>
<p>其他各个线程都无法获得锁，要等操作系统切回去</p>
<p>在操作系统中</p>
<p>会中断来实现锁</p>
<p>在操作系统内核：</p>
<p>连续上两次锁，中断一次再上锁，无法获得锁，就发生死锁</p>
<p>正确性准则</p>
<p>单处理器上锁解锁前后，中断状态不可改变，原来是中断还是中断，原来不中断还是不中断</p>
<p>多处理器，</p>
<p>使用栈保存中断状态</p>
<p>为了实现自旋一定要中断吗？</p>
<p>在用户态</p>
<p>因为自旋锁资源浪费严重</p>
<p>互斥锁（mutex）的实现使用了syscall，具有较好的scalability</p>
<p>futex如果没有锁直接访问，fast path</p>
<p>如何唤醒被syscall挂起的线程？</p>

        <h2 id="06-并发控制：互斥-1"   >
          <a href="#06-并发控制：互斥-1" class="heading-link"><i class="fas fa-link"></i></a><a href="#06-并发控制：互斥-1" class="headerlink" title="06-并发控制：互斥 (1)"></a>06-并发控制：互斥 (1)</h2>
      <p>自己思考一下，想各种情况，修改后可以立即用model checker来验证</p>

        <h2 id="互斥-2"   >
          <a href="#互斥-2" class="heading-link"><i class="fas fa-link"></i></a><a href="#互斥-2" class="headerlink" title="互斥 2)"></a>互斥 2)</h2>
      <p>关中断+自旋实现互斥</p>
<p>保存锁前中断状态</p>
</div></div></article><article class="postlist-item post"><header class="post-header"><h1 class="post-title"><a class="post-title__link" href="/2025/09/10/%E7%AC%94%E8%AE%B0%E6%9D%82%E9%A1%B9/os/pstree/">[ Untitled ]</a></h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2025-09-10</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2025-04-24</span></span></div></header><div class="post-body"><div class="post-excerpt"><p>1.解析参数</p>
<p>2.创建根节点</p>
<p>3.遍历进程文件建树，用read_proc_info读取父进程，创建节点</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> name[<span class="number">100</span>] = <span class="string">&quot;\0&quot;</span>; </span><br><span class="line">            <span class="type">pid_t</span> p = <span class="number">0</span>; </span><br><span class="line">            <span class="type">pid_t</span> pp = <span class="number">0</span>; </span><br><span class="line">            getPPid(stat_detail, &amp;p, name, &amp;pp);</span><br><span class="line"></span><br><span class="line">            ProcessNode* node = creatnode(name, p, pp);</span><br><span class="line">            ProcessNode* proc = process_table[pp];</span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span>(pp == <span class="number">0</span>)<span class="keyword">continue</span>;<span class="comment">//加上这一段就只能打印init</span></span><br><span class="line"></span><br><span class="line">            proc -&gt; children[proc -&gt; childrencount++] = node;</span><br></pre></td></tr></table></div></figure>

<p>本意是想取掉一个多余的0号进程，不打印</p>
<p>调试发现是出现了段错误，把print_tree改成打印table[0]就可以了</p>
<p>具体错误有待查询</p>
<p>打印节点</p>
<p>加前缀</p>
<figure class="highlight bash"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">init(Ubuntu-22.</span><br><span class="line">      ├──── init</span><br><span class="line">      ├──── SessionLeader</span><br><span class="line">      │     └──── Relay(17)</span><br><span class="line">      │           ├──── zsh</span><br><span class="line">      │           │     └──── pstree-64</span><br><span class="line">      │           ├──── zsh</span><br><span class="line">      │           │     └──── gitstatusd-linu</span><br><span class="line">      │           ├──── zsh</span><br><span class="line">      │           └──── zsh</span><br><span class="line">      └──── SessionLeader</span><br></pre></td></tr></table></div></figure>

<p>分三种情况</p>
<p>1.没有父进程，不加前缀</p>
<p>2.有父进程，但没有兄弟进程或者是兄弟进程中的最后一个<code>└──── </code></p>
<p>3.有父进程，有兄弟进程，且不是最后一个<code>├────</code></p>
<p>根据深度，加<code>|</code>或者空格</p>
<p>可以选择打印传入参数的子进程</p>
<p>修改printf函数之后就可以了</p>
<figure class="highlight c"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">print_tree</span><span class="params">(ProcessNode* node, <span class="type">int</span> level,<span class="type">char</span>* prefix)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (node -&gt; childrencount == <span class="number">0</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i &lt; node -&gt; childrencount;i++)</span><br><span class="line">    &#123;   </span><br><span class="line">        </span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, prefix);<span class="comment">//打印前缀</span></span><br><span class="line">        assert(node -&gt; children[i] != <span class="literal">NULL</span>);</span><br><span class="line">         <span class="comment">//printf(&quot;%s(%d)\n&quot;, node-&gt;children[i] -&gt; name,node-&gt;children[i] -&gt; pid);</span></span><br><span class="line">        <span class="keyword">if</span> (level &gt; <span class="number">0</span>) <span class="comment">//如果不是根节点，若是最后一个孩子，则打印└────，否则打印├────</span></span><br><span class="line">            <span class="built_in">printf</span>(node -&gt; childrencount == (i + <span class="number">1</span>) ? <span class="string">&quot;└──── &quot;</span> : <span class="string">&quot;├──── &quot;</span>);</span><br><span class="line">   </span><br><span class="line">        <span class="comment">//参数为true时，打印pid</span></span><br><span class="line">        <span class="keyword">if</span> (showpid == <span class="number">1</span>) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s(%d)\n&quot;</span>, node-&gt;children[i] -&gt; name,node-&gt;children[i] -&gt; pid);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, node-&gt;children[i] -&gt; name);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">char</span> new_prefix[MAX_SIZE];</span><br><span class="line">        <span class="built_in">strncpy</span>(new_prefix, prefix, <span class="keyword">sizeof</span>(new_prefix) - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (level &gt; <span class="number">0</span>)<span class="comment">//如果不是根节点，若是最后一个孩子，则前缀加空格，否则加竖线 </span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">strcat</span>(new_prefix, node-&gt;childrencount == (i + <span class="number">1</span>) ? <span class="string">&quot;      &quot;</span> : <span class="string">&quot;│     &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        print_tree(node-&gt;children[i], level + <span class="number">1</span>, new_prefix);<span class="comment">//递归打印孩子的孩子节点</span></span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>

</div></div></article></section><nav class="paginator"><div class="paginator-inner"><a class="extend prev" rel="prev" href="/page/2/"><i class="fas fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fas fa-angle-right"></i></a></div></nav></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><section class="sidebar-toc hide"></section><!-- ov = overview--><section class="sidebar-ov"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">Hello Stun</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">60</div><div class="sidebar-ov-state-item__name">Archives</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2025</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>John Doe</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v7.3.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.8.0</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="/js/utils.js?v=2.8.0"></script><script src="/js/stun-boot.js?v=2.8.0"></script><script src="/js/scroll.js?v=2.8.0"></script><script src="/js/header.js?v=2.8.0"></script><script src="/js/sidebar.js?v=2.8.0"></script></body></html>